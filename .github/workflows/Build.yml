name: Build TCP BBRv3 Kernel Module

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Clona tu repositorio del kernel
      - name: Clone Android kernel source
        run: |
          echo "ðŸ“¥ Clonando kernel..."
          git clone https://github.com/LeanxModulostk/android_kernel_samsung_m33.git kernel
          cd kernel
          git checkout main || true
          cd ..

      # Instala dependencias necesarias
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc flex bison clang llvm make gcc g++ \
            libncurses5-dev libssl-dev ccache git dwarves

      # Corrige error de Kconfig faltante (KernelSU)
      - name: Patch missing Kconfig files
        run: |
          cd kernel
          rm -rf drivers/kernelsu || true
          mkdir -p drivers/kernelsu
          echo "# Dummy KernelSU Kconfig to avoid build error" > drivers/kernelsu/Kconfig
          cd ..

      # Prepara los headers del kernel (importante!)
      - name: Prepare kernel headers
        run: |
          cd kernel
          echo "ðŸ§± Preparando headers del kernel..."
          make ARCH=arm64 defconfig
          make ARCH=arm64 modules_prepare
          cd ..

      # Compila el mÃ³dulo
      - name: Build BBRv3 module
        run: |
          echo "ðŸ”§ Compilando mÃ³dulo tcp_bbrv3..."
          make -C kernel ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- M=$(pwd) \
               EXTRA_CFLAGS="-I$(pwd)/kernel/net/ipv4"
          echo "âœ… CompilaciÃ³n finalizada"

      # Sube el archivo .ko compilado
      - name: Upload compiled module
        uses: actions/upload-artifact@v4
        with:
          name: tcp_bbr-ko
          path: "*.ko"
