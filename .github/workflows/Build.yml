name: Build TCP BBRv3 Kernel Module

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ”½ Clona tu kernel Android (ajusta el enlace si usas otro repo)
      - name: Clone Android kernel source
        run: |
          echo "ðŸ“¥ Clonando kernel..."
          git clone https://github.com/LeanxModulostk/android_kernel_samsung_m33x.git kernel
          cd kernel
          git checkout main || true
          cd ..

      # ðŸ§° Instala dependencias y toolchain ARM64
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc flex bison clang llvm make gcc g++ \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libncurses5-dev libssl-dev ccache git dwarves

      # ðŸ©¹ Corrige Kconfig faltante (drivers/kernelsu/)
      - name: Patch missing Kconfig files
        run: |
          cd kernel
          rm -rf drivers/kernelsu || true
          mkdir -p drivers/kernelsu
          echo "# Dummy KernelSU Kconfig to avoid build error" > drivers/kernelsu/Kconfig
          cd ..

      # ðŸ§± Prepara headers del kernel con el toolchain ARM64 correcto
      - name: Prepare kernel headers
        run: |
          cd kernel
          echo "ðŸ§± Preparando headers del kernel..."
          export CROSS_COMPILE=aarch64-linux-gnu-
          export ARCH=arm64
          make CROSS_COMPILE=aarch64-linux-gnu- ARCH=arm64 defconfig
          make CROSS_COMPILE=aarch64-linux-gnu- ARCH=arm64 modules_prepare
          cd ..

      # ðŸ”§ Compila el mÃ³dulo externo (por ejemplo tcp_bbrv3.c)
      - name: Build tcp_bbrv3 module
        run: |
          echo "ðŸ”§ Compilando mÃ³dulo tcp_bbrv3..."
          export CROSS_COMPILE=aarch64-linux-gnu-
          export ARCH=arm64
          make -C kernel ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- M=$(pwd) \
               EXTRA_CFLAGS="-I$(pwd)/kernel/net/ipv4"
          echo "âœ… CompilaciÃ³n finalizada"

      # ðŸ“¦ Sube el archivo .ko compilado
      - name: Upload compiled module
        uses: actions/upload-artifact@v4
        with:
          name: tcp_bbrv3-ko
          path: "*.ko"
