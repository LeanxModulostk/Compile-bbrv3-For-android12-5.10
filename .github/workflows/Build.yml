name: Build Kernel Module

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential bc flex bison libssl-dev clang llvm git

    - name: Clone kernel source
      run: |
        # Clona tu repositorio del kernel (ajusta si usas otro)
        git clone https://github.com/LeanxModulostk/android_kernel_samsung_m33x.git kernel
        cd kernel
        git checkout main || true
        cd ..

    - name: Patch missing Kconfig files
      run: |
        cd kernel
        rm -rf drivers/kernelsu || true
        mkdir -p drivers/kernelsu
        echo "# Dummy KernelSU Kconfig to avoid build error" > drivers/kernelsu/Kconfig
        cd ..

    - name: Create dummy kernel config
      run: |
        cd kernel
        echo "CONFIG_MODULES=y" > .config
        echo "CONFIG_NET=y" >> .config
        echo "CONFIG_TCP_CONG_ADVANCED=y" >> .config
        echo "CONFIG_TCP_CONG_BBR=m" >> .config
        echo "CONFIG_BBR=y" >> .config
        make ARCH=arm64 olddefconfig
        cd ..

    - name: Prepare kernel headers
      run: |
        cd kernel
        make ARCH=arm64 prepare
        make ARCH=arm64 modules_prepare
        cd ..

    - name: Build kernel module
      run: |
        echo "ðŸ”§ Building kernel module..."
        make -C kernel M=$(pwd) modules
        echo "âœ… Module build finished"

    - name: Upload compiled module
      uses: actions/upload-artifact@v4
      with:
        name: compiled-module
        path: "*.ko"
